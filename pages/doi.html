<div data-role="page">
  <style>
  .ui-selectmenu .ui-selectmenu-list li .ui-btn.ui-btn-active {
    color: #F44336
  }
  </style>
  <div class="navbar red">
    <div class="navbar-inner">
      <div class="left">
        <a href="" class="link" data-rel="back"><i class="material-icons">arrow_back</i></a>
      </div>
      <div class="title">Đổi</div>
    </div>
  </div>
  <div class="ui-content">
    <select data-native-menu="false" id="quantity_select" data-icon="false">
      <option value="temp">Nhiệt độ</option>
      <option value="length">Độ dài</option>
      <option value="mass">Khối lượng</option>
      <option value="area">Diện tích</option>
      <option value="volume">Thể tích</option>
      <option value="press">Áp suất</option>
      <option value="energy">Năng lượng</option>
      <option value="base">Cơ số</option>
      <option value="tnum">Kiểu số</option>
    </select>
    <div class="card">
      <label>Nhập ...</label>
      <input type="text" data-clear-btn="true" placeholder="0" id="input" />
    </div>
    <div class="row">
      <div class="col-50">
        <label>From</label>
        <select data-native-menu="false" id="from" data-icon="false">
          <option value="C">C</option>
          <option value="F">F</option>
          <option value="K">K</option>
        </select>
      </div>
      <div class="col-50">
        <label>To</label>
        <select data-native-menu="false" id="to" data-icon="false">
          <option value="C">C</option>
          <option value="F">F</option>
          <option value="K">K</option>
        </select>
      </div>
    </div>
    <div class="card">
      <div class="overflow">
        <div id="output">
          <span class="katex-display katex">0</span>
        </div>
      </div>
    </div>
  </div>
  <script>
  function check(ele1, ele2, arr) {
    if (arr.includes(ele1) && arr.includes(ele2))
      return !0;
    return !1
  }

  function tnum_function(f, t, str) {
    let result = '';
    let num = 0;
    if (f === 'Số Ả Rập' && t === 'Số La Mã') {
      num = +str;
      while (num >= 1000) {
        num -= 1000;
        result += 'M'
      }
      if (num >= 900) {
        num -= 900;
        result += 'CM'
      }
      if (num >= 500) {
        num -= 500;
        result += 'D'
      }
      if (num >= 400) {
        num -= 400;
        result += 'CD'
      }
      while (num >= 100) {
        num -= 100;
        result += 'C'
      }
      if (num >= 90) {
        num -= 90;
        result += 'XC'
      }
      if (num >= 50) {
        num -= 50;
        result += 'L'
      }
      if (num >= 40) {
        num -= 40;
        result += 'XL'
      }
      while (num >= 10) {
        num -= 10;
        result += 'X'
      }
      if (num >= 9) {
        num -= 9;
        result += 'IX'
      }
      if (num >= 5) {
        num -= 5;
        result += 'V'
      }
      if (num >= 4) {
        num -= 4;
        result += 'IV'
      }
      while (num >= 1) {
        num -= 1;
        result += 'I'
      }
    } else if (f === 'Số La Mã' && t === 'Số Ả Rập') {
      let mag_chu_so = [];
      let err = 0;
      for (let i = 0; i < str.length; i++) {
        if (str.charAt(i) === 'I')
          mag_chu_so[i] = 1;
        else if (str.charAt(i) === 'V')
          mag_chu_so[i] = 5;
        else if (str.charAt(i) === 'X')
          mag_chu_so[i] = 10;
        else if (str.charAt(i) === 'L')
          mag_chu_so[i] = 50;
        else if (str.charAt(i) === 'C')
          mag_chu_so[i] = 100;
        else if (str.charAt(i) === 'D')
          mag_chu_so[i] = 500;
        else if (str.charAt(i) === 'M')
          mag_chu_so[i] = 1000;
        else err = 1
      }
      if (err === 0) {
        num = mag_chu_so[str.length - 1];
        for (let i = str.length - 1; i > 0; i--) {
          if (mag_chu_so[i] > mag_chu_so[i - 1])
            num -= mag_chu_so[i - 1];
          else if (mag_chu_so[i] === mag_chu_so[i - 1] || mag_chu_so[i] < mag_chu_so[i - 1])
            num += mag_chu_so[i - 1]
        }
        result = num.toString()
      }
    } else
      result = str;
    return result;
  }


  var quantity = ['temp', 'length', 'mass', 'area', 'volume', 'press', 'energy', 'base', 'tnum'];
  var temp = ['C', 'F', 'K'];
  var unit = {
    length: ['mm', 'cm', 'm', 'km', 'inch', 'mile', 'yard', 'nmile', 'foot'],
    mass: ['mg', 'g', 'kg', 'tấn', 'grain', 'ounce', 'pound', 'stone'],
    area: ['cm2', 'm2', 'feet2', 'hectare', 'inch2', 'mile2', 'yard2', 'are'],
    volume: ['cm3', 'm3', 'feet3', 'inch3', 'l', 'yard3'],
    press: ['atm', 'Pa', 'mmHg'],
    energy: ['J', 'calo', 'Wh', 'eV']
  };
  var base = ['Hệ nhị phân', 'Hệ bát phân', 'Hệ thập phân', 'Hệ thập lục phân'];
  var tnum = ['Số Ả Rập', 'Số La Mã'];

  function base_function(f, t, str) {
    let number_array = [2, 8, 10, 16];
    let f_num = number_array[base.indexOf(f)];
    let t_num = number_array[base.indexOf(t)];
    let arr = str.replace(/\W/g, ' ').split(' ');
    let arr_m = [...arr];
    for (let i = 0; i < arr.length; i++) {
      arr[i] = parseInt(arr[i], f_num).toString();
      str = str.replace(arr_m[i], arr[i])
    }
    str = parseInt(nerdamer(str)).toString(t_num).toUpperCase();
    if (str !== 'NAN') {
      return str;
    }
    return '';
  }

  quantity_select.onchange = function() {
    let option = this.value;
    let option_tag = '';
    let li_tag = '';
    unit.temp = temp;
    unit.base = base;
    unit.tnum = tnum;
    $('#from, #to, #from-button, #to-button, #from-menu, #to-menu').html('');
    for (let i = 0; i < quantity.length; i++) {
      if (option === quantity[i]) {
        for (let j = 0, e = unit[option]; j < e.length; j++) {
          option_tag += `<option value="${e[j]}">${e[j]}</option>`;
          li_tag += j === 0 ? `<li data-option-index="0" data-icon="false" class="ui-first-child" role="option" aria-selected="true"><a href="#" tabindex="-1" class="ui-btn ui-btn-active">${e[j]}</a></li>` : j === e.length - 1 ? `<li data-option-index="${j}" data-icon="false" class="ui-last-child" role="option" aria-selected="false"><a href="#" tabindex="-1" class="ui-btn">${e[j]}</a></li>` : `<li data-option-index="${j}" data-icon="false" class="" role="option" aria-selected="false"><a href="#" tabindex="-1" class="ui-btn">${e[j]}</a></li>`
        }
        $('#from, #to').html(option_tag);
        $('#from-button, #to-button').html(`<span>${unit[option][0]}</span>`);
        $('#from-menu, #to-menu').html(li_tag);
      }
    }
    $('#input').val('');
    $('.ui-input-clear').addClass('ui-input-clear-hidden');
    output.innerHTML = `<span class="katex-display katex">&nbsp;</span>`
  }

  function main() {
    let result = input.value;
    let f = from.value;
    let t = to.value;
    let option = quantity_select.value;
    let vch = {
      length: [1, 10, 1000, 1000000, 25.4, 1609344, 914.4, 1852000, 304.8],
      mass: [1, 1000, 1000000, 1000000000, 64.891, 28349.512, 453592.37, 6350293.18],
      area: [1, 10000, 929.0304, 100000000, 6.451612903225806, 25899880000, 8361.2736, 1000000],
      volume: [1, 1000000, 28317, 16.38699528054536, 1000, 764555],
      press: [1, 0.000009869232667160129, 0.0013157894736842105],
      energy: [1, 4.1858, 3600, 1.6e-19]
    };
    let err = 0;
    delete unit.temp;
    delete unit.base;
    delete unit.tnum;

    if (option === 'base') {
      result = base_function(f, t, result);
    } else if (option === 'tnum') {
      result = tnum_function(f, t, result);
    } else {
      for (let i in unit) {
        if (check(f, t, unit[i])) {
          if (f != unit[i][0]) result *= vch[i][unit[i].indexOf(f)];
          if (t != unit[i][0]) result /= vch[i][unit[i].indexOf(t)];
          err++
        }
      }

      if (check(f, t, temp)) {
        if (f != 'C') {
          if (f == 'F') {
            result = (5.0 / 9.0) * (result - 32.0);
          }
          if (f == 'K') {
            result -= 273.15
          }
        }
        if (t != 'C') {
          if (t == 'F') {
            result = (9.0 / 5.0) * result + 32.0;
          }
          if (t == 'K') {
            result += 273.15
          }
        }
        err++
      }

      if (err === 0) {
        result = ''
      }
    }

    output.innerHTML = `<span class="katex-display katex">${result}</span>`
  }

  input.oninput = function() {
    if (this.value !== '') {
      main()
    }
  }

  $('#from, #to').on('change', function() {
    if ($('#input').val() !== '') {
      main()
    }
  })
  </script>
</div>