<div data-role="page">
  <style>
  .input:focus {
    border-bottom-color: #512da8
  }

  .ui-selectmenu .ui-selectmenu-list li .ui-btn.ui-btn-active {
    color: #512da8
  }
  </style>
  <div class="navbar deep-purple darken-2">
    <div class="navbar-inner">
      <div class="left">
        <a href="#" class="link" data-rel="back"><i class="material-icons">arrow_back</i></a>
      </div>
      <div class="title">Ma trận</div>
    </div>
  </div>
  <div class="ui-content">
    <select data-native-menu="false" data-icon="false" id="select">
      <option value="matA_area">Nhập ma trận A</option>
      <option value="matB_area">Nhập ma trận B</option>
      <option value="matC_area">Nhập ma trận C</option>
      <option value="main_area">Tính toán</option>
    </select>
    <div id="matA_area" class="content">
      <div class="row">
        <div class="col-50">
          <label>Số dòng</label>
          <select data-native-menu="false" data-icon="false" id="matA_rows">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="col-50">
          <label>Số cột</label>
          <select data-native-menu="false" data-icon="false" id="matA_cols">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>
      <div class="card overflow-nowrap">
        <div id="matA_input"></div>
      </div>
    </div>
    <div id="matB_area" class="content hide">
      <div class="row">
        <div class="col-50">
          <label>Số dòng</label>
          <select data-native-menu="false" data-icon="false" id="matB_rows">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="col-50">
          <label>Số cột</label>
          <select data-native-menu="false" data-icon="false" id="matB_cols">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>
      <div class="card overflow-nowrap">
        <div id="matB_input"></div>
      </div>
    </div>
    <div id="matC_area" class="content hide">
      <div class="row">
        <div class="col-50">
          <label>Số dòng</label>
          <select data-native-menu="false" data-icon="false" id="matC_rows">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div class="col-50">
          <label>Số cột</label>
          <select data-native-menu="false" data-icon="false" id="matC_cols">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>
      <div class="card overflow-nowrap">
        <div id="matC_input"></div>
      </div>
    </div>
    <div id="main_area" class="content hide">
      <div class="card">
        <label>Nhập biểu thức</label>
        <input type="text" data-clear-btn="true" placeholder="matA*invert(matB)" id="input" />
      </div>
      <button class="button katex deep-purple darken-2">=</button>
      <div class="card overflow-nowrap">
        <div id="output">
          <span class="katex-display katex">0</span>
        </div>
      </div>
    </div>
  </div>
  <script>
  let Matrix = core.Matrix;
  let math = core.Utils.importFunctions();

  function hilbert(n) {
    let m = new Matrix();
    for (let i = 0; i < n; i++) {
      m.elements.push([]);
      for (let j = 0; j < n; j++) {
        m.set(i, j, new Symbol(1 / (i + j + 1)));
      }
    }
    return m;
  }

  function adjunct(m) {
    return _.multiply(math.determinant(m), math.invert(m));
  }

  nerdamer.register([{
    name: 'hilbert',
    numargs: 1,
    visible: true,
    build: function() { 
      return hilbert; 
    }
  }, {
    name: 'adjunct',
    numargs: 1,
    visible: true,
    build: function() { 
      return adjunct; 
    }
  }]);

  $('.hide').hide();

  $('#select').on('change', function() {
    $('.content').hide();
    $(`#${$(this).val()}`).show();
  });

  $('#input').textcomplete([{
    match: /(^|\b)(\w{1,})$/,
    search(term, callback) {
      let words = ['determinant', 'invert', 'imatrix', 'transpose', 'matA', 'matB', 'matC', 'hilbert', 'adjunct'];
      callback($.map(words, word => word.indexOf(term) === 0 ? word : null));
    },
    replace(word) {
      if (word === 'matA' || word === 'matB' || word === 'matC') {
        return word;
      } else {
        return `${word}()`;
      }
    }
  }]);

  let matA, matB, matC;
  
  matA_input.innerHTML = `<input type="text" data-role="none" class="input" id="a00" />`;
  matB_input.innerHTML = `<input type="text" data-role="none" class="input" id="b00" />`;
  matC_input.innerHTML = `<input type="text" data-role="none" class="input" id="c00" />`;
  
  $('#matA_rows, #matA_cols').on('change', function() {
    matA = '';
    let row = $('#matA_rows').val();
    let col = $('#matA_cols').val();
    for (let i = 0; i < row; i++) {
      for (let j = 0; j < col; j++) {
        matA += `<input type="text" data-role="none" class="input" id="a${i}${j}" /> &nbsp;`;
      }
      if (i < row - 1) {
        matA += '<br />';
      }
    }
    matA_input.innerHTML = matA;
  });

  $('#matB_rows, #matB_cols').on('change', function() {
    matB = '';
    let row = $('#matB_rows').val();
    let col = $('#matB_cols').val();
    for (let i = 0; i < row; i++) {
      for (let j = 0; j < col; j++) {
        matB += `<input type="text" data-role="none" class="input" id="b${i}${j}" /> &nbsp;`;
      }
      if (i < row - 1) {
        matB += '<br />';
      }
    }
    matB_input.innerHTML = matB;
  });

  $('#matC_rows, #matC_cols').on('change', function() {
    matC = '';
    let row = $('#matC_rows').val();
    let col = $('#matC_cols').val();
    for (let i = 0; i < row; i++) {
      for (let j = 0; j < col; j++) {
        matC += `<input type="text" data-role="none" class="input" id="c${i}${j}" /> &nbsp;`;
      }
      if (i < row - 1) {
        matC += '<br />';
      }
    }
    matC_input.innerHTML = matC;
  });

  $('.button').click(function() {
    matA = 'matrix(';
    for (let i = 0; i < matA_rows.value; i++) {
      matA += '[';
      for (let j = 0; j < matA_cols.value; j++) {
        matA += document.getElementById(`a${i}${j}`).value;
        if (j < matA_cols.value - 1) {
          matA += ',';
        } 
      }
      matA += ']';
      if (i < matA_rows.value - 1) {
        matA += ',';
      }
    }
    matA += ')';

    matB = 'matrix(';
    for (let i = 0; i < matB_rows.value; i++) {
      matB += '[';
      for (let j = 0; j < matB_cols.value; j++) {
        matB += document.getElementById(`b${i}${j}`).value;
        if (j < matB_cols.value - 1) {
          matB += ',';
        }
      }
      matB += ']';
      if (i < matB_rows.value - 1)
        matB += ',';
    }
    matB += ')';

    matC = 'matrix(';
    for (let i = 0; i < matC_rows.value; i++) {
      matC += '[';
      for (let j = 0; j < matC_cols.value; j++) {
        matC += document.getElementById(`c${i}${j}`).value;
        if (j < matC_cols.value - 1) {
          matC += ',';
        }
      }
      matC += ']';
      if (i < matC_rows.value - 1)
        matC += ',';
    }
    matC += ')';

    nerdamer.clearVars();
    nerdamer.setVar('matA', matA);
    nerdamer.setVar('matB', matB);
    nerdamer.setVar('matC', matC);

    output.innerHTML = katex.renderToString(nerdamer(input.value).toTeX().replace(/,$|\\cdot(?= \\| [a-z])/g, ''), {
      displayMode: true
    });
  });
  </script>
</div>